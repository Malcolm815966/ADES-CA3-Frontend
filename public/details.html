<!-- Class: DIT/FT/1B/04
Admission Number: p2020994
Name: Malcolm Ng -->

<!DOCTYPE html>

<head>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns"
    crossorigin="anonymous"></script>

</head>


<body
  style="background-image: url(http://localhost:3001/image/background.jpg); background-size:cover; overflow-y: scroll;">

  <!-- Page Title -->
  <div class="d-flex justify-content-center"
    style="border-bottom-style: solid; border-color: grey;background-color: #47476b; text-align:center; font-size: 75px; font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;">
    <p style="margin: 0; display: inline; color: red; font-weight: bold;">SP&nbsp;</p>
    <p style="margin: 0; display: inline; color: white; font-weight: bold;">Games</p>
  </div>

  <header
    style="background-color: #47476b; padding-top: 10px; padding-bottom: 10px; padding-left: 10px; padding-right: 10px;">

    <!-- Navigation Bar -->
    <button style="background-color: transparent; border:transparent" type="button" class="btn btn-primary"
      onclick="goBacktoGame()">
      <i class="fa fa-gamepad" style="color: white; font-size: large;"> All Games</i>
    </button>

    <button style="background-color: transparent; border:transparent" type="button" class="btn btn-primary">
      <i class="fa fa-user-circle" style="color: white; font-size: large;"> Profile</i>
    </button>

    <button id="addGamesNav" style="background-color: transparent; border:transparent" type="button"
      class="btn btn-primary" onclick="goToAddGamesPage()">
      <i class="fa fa-plus" style="color: white; font-size: large;"> Add Games</i>
    </button>

    <button id="addCategoriesNav" style="background-color: transparent; border:transparent" type="button"
      class="btn btn-primary" onclick="goToAddCategoriesPage()">
      <i class="fa fa-file-text" style="color: white; font-size: large;"> Add Categories</i>
    </button>

    <!-- Buttons to trigger modal -->
    <button style="background-color: transparent; border:transparent" type="button" class="btn btn-primary"
      data-toggle="modal" data-target="#loginModal" id="loginNavButton">
      <i class="fa fa-key" style="color: white; font-size: large;"> Login</i>
    </button>

    <button style="background-color: transparent; border:transparent" type="button" class="btn btn-primary"
      data-toggle="modal" data-target="#logoutModal" id="logoutNavButton">
      <i class="fa fa-sign-out" style="color: white; font-size: large;"> Log out</i>
    </button>
  </header>

  <!-- Display game details -->
  <div class="container d-flex" style="justify-content: center;">
    <div class="row" id="gameDetails">
    </div>
  </div>

  <!-- Add Review and Rating Input Boxes -->
  <div class="container">
    <h2 style="text-align: center;">Leave a review and rating!</h2>
    <form>
      <div class="form-group">
        <textarea placeholder="Review:" class="form-control" rows="5" id="reviewInput" required></textarea>
      </div>
      <input type="text" class="form-control" placeholder="Rating out of 5.0" id="ratingInput" required>
    </form>
    <button
      style="background-color: #7575a3; border:transparent; height:min-content; color: white; font-weight: bold; float: right; margin-top: 10px;"
      type="button" class="btn btn-primary" id="addReviewButton">Post
    </button>
  </div>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" data-backdrop="static" data-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="login-form">
            <form action="">
              <h2 class="text-center">Login</h2>
              <div class="form-group">
                <input type="email" class="form-control" id="email" placeholder="Email" required="required">
              </div>
              <div class="form-group">
                <input type="password" class="form-control" id="pwd" placeholder="Password" required="required">
              </div>
              <div class="modal-footer">
                <button type="reset" class="btn btn-secondary Clear" id="loginModalClear">Clear</button>
                <button type="submit" class="btn btn-primary" id="loginModalLogin">Log in</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Logout Modal -->
  <div class="modal fade" id="logoutModal" data-backdrop="static" data-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="login-form">
            <form action="">
              <h5 class="text-center">Are you sure you want to log out?</h5>
              <div class="modal-footer">
                <button type="submit" class="btn btn-primary" id="logoutModalLogout">Log out</button>
              </div>

            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

<!-- Goes back to Games main page when Games button is clicked -->
<script>
  function goBacktoGame() {
    window.localStorage.removeItem("gameid");
    window.location.assign("http://localhost:3001");
  }
</script>

<!-- Goes to addGames.html page -->
<script>
  function goToAddGamesPage() {
    window.location.assign("http://localhost:3001/addGames.html")
  }
</script>

<!-- Goes to addCategories.html page -->
<script>
  function goToAddCategoriesPage() {
    window.location.assign("http://localhost:3001/addCategories.html")
  }
</script>

<!-- Hide and Show buttons depending on whether user is logged in (also depends on user role) or not -->
<script>
  if (localStorage.getItem('type') == null) {
    $("#loginNavButton").show();
    $("#logoutNavButton").hide();
    $("#addGamesNav").hide();
    $("#addCategoriesNav").hide();
  } else if (localStorage.getItem('type') == "Customer") {
    $("#loginNavButton").hide();
    $("#logoutNavButton").show();
    $("#addGamesNav").hide();
    $("#addCategoriesNav").hide();
  } else if (localStorage.getItem('type') == "Admin") {
    $("#loginNavButton").hide();
    $("#logoutNavButton").show();
    $("#addGamesNav").show();
    $("#addCategoriesNav").show();
  }
</script>

<!-- Clear Local Storage login data when user logs out -->
<script>
  $("#logoutModalLogout").click(function (event) {
    window.localStorage.removeItem("Token");
    window.localStorage.removeItem("userid");
    window.localStorage.removeItem("Username");
    window.localStorage.removeItem("type");
  });
</script>

<!-- Login, verify for correct email and password -->
<script>
  $(document).ready(function () {
    $("#loginModalLogin").click(function () {
      var email = $('#email').val();
      var pwd = $('#pwd').val();
      var data = "{\"email\":\"" + email + "\", \"password\":\"" + pwd + "\"}";
      console.log(data);
      $.ajax({
        url: 'https://cryptic-headland-94862.herokuapp.com/https://ades-ca3-backendserver.herokuapp.com/user/login',
        type: 'POST',
        data: data,
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (data, textStatus, xhr) {
          if (data != null) {
            var result = JSON.parse(data.UserData);
            localStorage.setItem('Token', data.token);
            localStorage.setItem('Username', result.username);
            localStorage.setItem('userid', result.userid);
            localStorage.setItem('type', result.type); // just to check for user type and hide and show buttons accordingly, not for adding games etc
            $("#loginNavButton").hide();
            $("#logoutNavButton").show();
            if (localStorage.getItem("type") == "Customer") {
              $("#addGamesNav").hide();
              $("#addCategoriesNav").hide();
            } else if (localStorage.getItem("type") == "Admin") {
              $("#addGamesNav").show();
              $("#addCategoriesNav").show();
            }
            $("#loginModal").modal('hide');
          } else {
            console.log("Error");
          }
        },
        error: function (xhr, textStatus, errorThrown) {
          console.log('Error in Operation');
          alert("You have entered the wrong email or password.\nPlease try again.");
        }
      });
      return false;
    });
  });
</script>

<!-- Display game details from database -->
<script>
  $(document).ready(function () {
    $.ajax({
      url: 'https://cryptic-headland-94862.herokuapp.com/https://ades-ca3-backendserver.herokuapp.com/displayGameDetails/' + localStorage.getItem("gameid"),
      type: 'GET',
      contentType: "application/json; charset=utf-8",
      dataType: "json",
      success: function (data, textStatus, xhr) {
        console.log(data)
        data.forEach((ele) => {
          $('#gameDetails').html(`<div class="card" style="width:400px">
        <img class="card-img-top" src="http://localhost:3001/image/${ele.image_file}" alt="Card image">
        <div class="card-body" id="gameDetailsCard">
          <h4 id="title" class="card-title" style="color: #5c5c8a;"><u>Title</u></h4>
          <p class="card-text">${ele.title}</p>
          <h4 id="category" class="card-title" style="color: #5c5c8a;"><u>Category</u></h4>
          <p class="card-text">${ele.catname}</p>
          <h4 id="year" class="card-title" style="color: #5c5c8a;"><u>Year Published:</u></h4>
          <p class="card-text">${ele.year}</p>
          <h4 id="platform" class="card-title" style="color: #5c5c8a;"><u>Platform</u></h4>
          <p class="card-text">${ele.platform}</p>
          <h4 id="price" class="card-title" style="color: #5c5c8a;"><u>Price</u></h4>
          <p class="card-text">${ele.price}</p>
          <h4 id="description" class="card-title" style="color: #5c5c8a;"><u>Description</u></h4>
          <p class="card-text">${ele.description}</p>
          <h4 class="card-title" style="color: #5c5c8a;" id="prependAverageRating"><u>Reviews:</u></h4>
        </div>
      </div>`);
        });
      },
      error: function (xhr, textStatus, errorThrown) {
        console.log('Error in Operation');
      }
    });
    return false;
  });
</script>

<!-- Display game reviews from database -->
<script>
  $(document).ready(function () {
    $.ajax({
      url: 'https://cryptic-headland-94862.herokuapp.com/https://ades-ca3-backendserver.herokuapp.com/displayGameReviews/' + localStorage.getItem("gameid"),
      type: 'GET',
      contentType: "application/json; charset=utf-8",
      dataType: "json",
      success: function (data, textStatus, xhr) {
        console.log(data)

        var count = 0; // counts the number of ratings
        var totalRating = 0;
        data.forEach((ele) => {
          totalRating += ele.rating * 1;
          count++;
          $('#gameDetailsCard').append(`<div style="border-style: none none solid none;">
          <p class="card-text">${ele.content}</p>
          <p class="card-text">${ele.rating} / 5.0</p>
          <p class="card-text">From: ${ele.username}</p>
          <p class="card-text">Posted: ${ele.created_at}</p>
          </div>`);
        });
        $('#prependAverageRating').prepend(`<p><u>Average Rating:</u></p>
        <p>${(totalRating / count).toFixed(1)} / 5.0</p>`);
      },
      error: function (xhr, textStatus, errorThrown) {
        console.log('Error in Operation');
      }
    });
    return false;
  });
</script>

<!-- Adds new review and appends it -->
<script>
  $(document).ready(function () {
    $("#addReviewButton").click(function () {
      var content = document.getElementById("reviewInput").value;
      var rating = document.getElementById("ratingInput").value;
      var userid = window.localStorage.getItem('userid')
      var gameid = window.localStorage.getItem('gameid')
      if (rating <= 5 && rating > 0 && content != null) {
        var requestBody = { content: content, rating: rating, userid: userid, gameid: gameid }
        $.ajax({
          url: 'https://cryptic-headland-94862.herokuapp.com/https://ades-ca3-backendserver.herokuapp.com/addReviews/' + JSON.stringify(requestBody),
          type: 'POST',
          headers: { "Authorization": "Bearer " + window.localStorage.getItem('Token') },
          contentType: "application/json; charset=utf-8",
          dataType: "json",
          success: function (data, textStatus, xhr) {
            window.location.reload();
          },
          error: function (xhr, textStatus, errorThrown) {
            window.alert("Please sign in as a Customer!")
            console.log('Error in Operation');
          }
        });
        return false;
      } else {
        window.alert("Please fill up all boxes with rating 5 or below!")
      }
    });
  });
</script>

</html>